<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src\site\apt/server_oauth2.apt at 2021-02-27

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>GraphQL Java Generator - Maven Plugin &#x2013; Implementing an OAuth2 secured GraphQL server</title>
    <link rel="stylesheet" href="./css/maven-base.css" />
    <link rel="stylesheet" href="./css/maven-theme.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<div id="bannerLeft">com.graphql-java-generator:graphql-maven-plugin-project
</div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="projectVersion">Version: 1.12.3</span>
      </div>
      <div class="xright"><a href="project.html" title="Project on Github">Project on Github</a>        &#xA0;| <span id="publishDate">Last Published: 2021-02-27</span>
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Plugin Usage</h5>
    <ul>
     <li class="none"><a href="README.html" title="Introduction">Introduction</a></li>
     <li class="none"><a href="change_log.html" title="Change Log">Change Log</a></li>
     <li class="none"><a href="customscalars.html" title="Custom Scalars">Custom Scalars</a></li>
     <li class="none"><a href="customtemplates.html" title="Custom Code Templates">Custom Code Templates</a></li>
     <li class="none"><a href="faq_client_and_server.html" title="FAQ (for both client and server mode)">FAQ (for both client and server mode)</a></li>
    </ul>
       <h5>Client mode</h5>
    <ul>
     <li class="none"><a href="client_spring.html" title="Creating a first app (spring)">Creating a first app (spring)</a></li>
     <li class="none"><a href="client_non_spring.html" title="Creating a first app (non spring)">Creating a first app (non spring)</a></li>
     <li class="none"><a href="exec_graphql_requests.html" title="Execute GraphQL requests">Execute GraphQL requests</a></li>
     <li class="none"><a href="client_tutorial.html" title="Client Tutorial">Client Tutorial</a></li>
     <li class="none"><a href="client_subscription.html" title="Subscription">Subscription</a></li>
     <li class="none"><a href="introspection.html" title="Introspection">Introspection</a></li>
     <li class="none"><a href="client_add_relay_connection.html" title="Relay Connections">Relay Connections</a></li>
     <li class="none"><a href="runtimeclasses.html" title="Runtime Classes">Runtime Classes</a></li>
     <li class="none"><a href="client_oauth2.html" title="Access to an OAuth2 GraphQL server">Access to an OAuth2 GraphQL server</a></li>
     <li class="none"><a href="client_personalization.html" title="How to personalize the client app">How to personalize the client app</a></li>
     <li class="none"><a href="faq_client.html" title="FAQ (client mode)">FAQ (client mode)</a></li>
    </ul>
       <h5>Server mode</h5>
    <ul>
     <li class="none"><a href="server.html" title="Server usage">Server usage</a></li>
     <li class="none"><a href="server_tutorial.html" title="Server Tutorial">Server Tutorial</a></li>
     <li class="none"><a href="server_subscription.html" title="Subscription">Subscription</a></li>
     <li class="none"><a href="server_add_relay_connection.html" title="Relay Connections">Relay Connections</a></li>
     <li class="none"><strong>Implement an OAuth2 GraphQL server</strong></li>
     <li class="none"><a href="schema_personalization.html" title="Howto personalize the generated code">Howto personalize the generated code</a></li>
    </ul>
       <h5>Project internal</h5>
    <ul>
     <li class="none"><a href="howto_build.html" title="How to build?">How to build?</a></li>
     <li class="none"><a href="howto_contribute.html" title="How to contribute?">How to contribute?</a></li>
     <li class="none"><a href="howto_pgp_key.html" title="How to create a PGP key?">How to create a PGP key?</a></li>
     <li class="none"><a href="howto_release.html" title="How to release?">How to release?</a></li>
    </ul>
       <h5>Modules</h5>
    <ul>
     <li class="none"><a href="graphql-java-runtime/index.html" title="graphql-java-runtime">graphql-java-runtime</a></li>
     <li class="none"><a href="graphql-maven-plugin/index.html" title="graphql-maven-plugin">graphql-maven-plugin</a></li>
     <li class="none"><a href="graphql-java-client-dependencies/index.html" title="graphql-java-client-dependencies">graphql-java-client-dependencies</a></li>
     <li class="none"><a href="graphql-java-server-dependencies/index.html" title="graphql-java-server-dependencies">graphql-java-server-dependencies</a></li>
     <li class="none"><a href="graphql-maven-plugin-logic/index.html" title="graphql-maven-plugin-logic">graphql-maven-plugin-logic</a></li>
     <li class="none"><a href="graphql-maven-plugin-samples/index.html" title="graphql-maven-plugin-samples">graphql-maven-plugin-samples</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="project-info.html" title="Project Information">Project Information</a></li>
    </ul>
      <a href="https://maven.apache.org/" title="Maven" class="poweredBy">
        <img class="poweredBy"  alt="Maven" src="https://maven.apache.org/images/logos/maven-feather.png"     />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<section>
<h2><a name="Implementing_an_OAuth2_secured_GraphQL_server"></a>Implementing an OAuth2 secured GraphQL server</h2>
<ul>
<li><a href="#Implementing_an_OAuth2_secured_GraphQL_server">Implementing an OAuth2 secured GraphQL server</a>
<ul>
<li><a href="#Introduction">Introduction</a></li>
<li><a href="#Sample">Sample</a></li>
<li><a href="#The_http_error_codes">The http error codes</a></li>
<li><a href="#Some_CURL_command_to_check_the_OAuth_configuration">Some CURL command to check the OAuth configuration</a></li>
<li><a href="#Enable_the_proper_dependencies">Enable the proper dependencies</a></li>
<li><a href="#Configure_OAuth2_on_server_side.2C_with_Spring_Boot">Configure OAuth2 on server side, with Spring Boot</a></li>
<li><a href="#Enable_OAuth2_on_server_side">Enable OAuth2 on server side</a></li></ul></li></ul><section>
<h3><a name="Introduction">Introduction</a></h3>
<p>Thanks to Spring magic, it's quite easy to secure a GraphQL server with OAuth. It's just a matter of adding some Spring beans, and let the Spring Boot autoconfiguration work.</p>
<p>The only issue is to test your server, as <i>graphiql</i> won't be able to generate an OAuth token.</p>
<p>This page won't detail more the OAuth protocol. You'll find more information on the web. And a good idea is to start by <a class="externalLink" href="https://aaronparecki.com/oauth-2-simplified/">OAuth presentation</a>.</p></section><section>
<h3><a name="Sample">Sample</a></h3>
<p>This page is based on the <a class="externalLink" href="https://github.com/graphql-java-generator/graphql-maven-plugin-project/tree/master/graphql-maven-plugin-samples/graphql-maven-plugin-samples-allGraphQLCases-client">graphql-maven-plugin-samples-allGraphQLCases-client</a> sample.</p>
<p>This sample can be executed, when the servers below are started. They are available in the maven plugin project:</p>
<ul>
<li>The OAuth2 Authorization server is in the <i>graphql-maven-plugin-samples-OAuth-authorization-server</i> module.
<ul>
<li>To start it, just execute the <i>com.marcosbarbero.lab.sec.oauth.opaque.OAuth2OpaqueAuthorizationServerApp</i> class, as a java application.</li>
<li>This server listen on the 8181 port. If you want to change it, you'll have to change its application.yml properties file, and the other application properties files accordingly.</li></ul></li>
<li>The GraphQL server is in the <i>graphql-maven-plugin-samples-allGraphQLCases-server</i> module.
<ul>
<li>To start it, you'll have to build it, then execute the <i>org.allGraphQLCases.server.util.GraphQLServerMain</i>, generated by the graphql plugin in the <i>target/generated-sources/graphql-maven-plugin</i> folder.</li>
<li>This server listen on the 8180 port. If you want to change it, you'll have to change its application.yml properties file, and the other application properties files accordingly.</li></ul></li>
<li>You can use the <i>graphql-maven-plugin-samples-allGraphQLCases-client</i> module, to test the access to the <i>graphql-maven-plugin-samples-allGraphQLCases-server</i> GraphQL server.</li></ul></section><section>
<h3><a name="The_http_error_codes">The http error codes</a></h3>
<p>Here is an important notice about the HTTP status code that you may encounter here:</p>
<ul>
<li>401 means there is no OAuth authorization. There is an issue with the configuration, and probably no OAuth token is given to the resource server. Or the token is invalid.</li>
<li>403 means that the resource server receives the OAuth authorization, and the token is valid. But for some reason, you're not allowed to access to this resource.</li></ul></section><section>
<h3><a name="Some_CURL_command_to_check_the_OAuth_configuration">Some CURL command to check the OAuth configuration</a></h3>
<p>As usual, it may happen (hum, ok, it always happens :) ) that some issue prevents your code to work as expected. So here are some useful commands, to check if the whole system is properly configured or not.</p>
<p>All these commands are based on the <i>graphql-maven-plugin-samples-allGraphQLCases</i> resource server, and the <i>graphql-maven-plugin-samples-OAuth-authorization-server</i> authorization server, as provided in the <a class="externalLink" href="https://github.com/graphql-java-generator/graphql-maven-plugin-project">maven GraphQL plugin project</a>.</p>
<p>This commands:</p>
<ul>
<li>Are based on the <a class="externalLink" href="https://curl.se/">curl</a> command line tool.</li>
<li>The <i>-i</i> parameter allows to show the full response</li>
<li>The <i>--noproxy &quot;*&quot;</i> is necessary in my config, to avoid curl to send all these commands in the proxy, as the servers are local ones.</li>
<li>Contains tokens that you'll need to update, according to the one you'll get from the first request. </li></ul>
<p>A sample query, to get an OAuth token:</p>
<div class="source">
<pre>curl -u &quot;clientId:secret&quot; -X POST &quot;http://localhost:8181/oauth/token?grant_type=client_credentials&quot; --noproxy &quot;*&quot; -i
</pre></div>
<p>Then, reuse the previous token in the next query:</p>
<div class="source">
<pre>curl -i -X POST &quot;http://localhost:8180/graphql&quot; --noproxy &quot;*&quot; -H &quot;Authorization: Bearer 8c8e4a5b-d903-4ed6-9738-6f7f364b87ec&quot;
</pre></div>
<p>And, to check the token:</p>
<div class="source">
<pre>curl -i -X GET &quot;http://localhost:8181/profile/me&quot; --noproxy &quot;*&quot; -H &quot;Authorization: Bearer 8c8e4a5b-d903-4ed6-9738-6f7f364b87ec&quot;
</pre></div></section><section>
<h3><a name="Enable_the_proper_dependencies">Enable the proper dependencies</a></h3>
<p>Of course, in order to make all this work, you need some code in your classpath.</p>
<p>If you included <i>com.graphql-java-generator:graphql-java-server-dependencies:pom</i>, in your dependencies, everything should be ok. This includes this dependencies:</p>
<div class="source">
<pre>                &lt;dependency&gt;
                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
                &lt;/dependency&gt;
                &lt;dependency&gt;
                        &lt;groupId&gt;org.springframework.security.oauth.boot&lt;/groupId&gt;
                        &lt;artifactId&gt;spring-security-oauth2-autoconfigure&lt;/artifactId&gt;
                        &lt;version&gt;2.4.0&lt;/version&gt;
                &lt;/dependency&gt;
</pre></div>
<p>There is an issue here: take care at the version for the <i>spring-security-oauth2-autoconfigure</i> dependency. As of 2.4.0, its version is not managed. That is: there is no default value for it. So you must give its version a value. The issue is that this version must the same as the version for the other versions of Spring Boot autoconfiguration.</p>
<p>So, when you update the graphql plugin version, take a look at the effective pom, and check the <i>org.springframework.boot:spring-boot-autoconfigure</i> version. In eclipse, once a pom file is open, you see the effective pom by clicking on <i>Effective POM</i>, in the lower part of the window. </p>
<p>You can also check the <a class="externalLink" href="https://github.com/graphql-java-generator/graphql-maven-plugin-project/blob/master/graphql-maven-plugin-samples/graphql-maven-plugin-samples-allGraphQLCases-server/pom.xml">pom.xml</a> file in github, but take care that this is the last version, and it may be &quot;in advance&quot;, compared to the plugin version you're using.</p></section><section>
<h3><a name="Configure_OAuth2_on_server_side.2C_with_Spring_Boot"></a><a name="Configure_OAuth2_on_server_side_with_Spring_Boot">Configure OAuth2 on server side, with Spring Boot</a></h3>
<p>To configure OAuth2, there are tons of documentations on the web. But you should start from this sample. Below is an extract of the <i>application.yml</i> file of the <i>graphql-maven-plugin-samples-allGraphQLCases-server</i> module. This file must on the root of the resource folder. Here it is:</p>
<div class="source">
<pre># Changing the port for the GraphQL server
server:
  port: 8180

# https://docs.spring.io/spring-security-oauth2-boot/docs/current/reference/html5/#oauth2-boot-resource-server-token-info
security:
  oauth2:
    client:
      client-id: clientId
      client-secret: secret
    resource:
      introspection-uri: http://localhost:8181/oauth/check_token
</pre></div>
<p>The first part is the GraphQL configuration part.</p>
<p>The second part deals with OAuth, and how to access the authorization server:</p>
<ul>
<li>A basic authentication</li>
<li>The URL to check the opaque server</li></ul>
<p>You'll find tons of docs on the web, on how to configure the Spring for other kind of tokens, including JWT.</p></section><section>
<h3><a name="Enable_OAuth2_on_server_side">Enable OAuth2 on server side</a></h3>
<p>To enable OAuth on server side, it's just a matter of activating and configuring Spring Security. To do that, you add a class marked by the <i>@Component</i> annotation, in a subpackage where the code is generated. That is:</p>
<ul>
<li>If you didn't define the <i>packageName</i> plugin parameter, nor the <i>scanBasePackages</i>: then this class must be in the <i>com.generated.graphql</i> package, or in one of its subpackages.</li>
<li>If you defined only the <i>packageName</i> plugin parameter: then this class must be in this package, or in one of its subpackages.</li>
<li>If you defined the <i>scanBasePackages</i> plugin parameter: then this class must be in one of these packages, or in one of their subpackages.</li></ul>
<p>Don't forget the <i>@Component</i> annotation!</p>
<p>Here is a sample:</p>
<div class="source">
<pre>package org.allGraphQLCases.server.oauth2;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.security.oauth2.resource.FixedAuthoritiesExtractor;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;

/**
 * 
 * @author etienne-sf
 * @see https://docs.spring.io/spring-security/site/docs/5.4.2/reference/html5/#servlet-authorization-filtersecurityinterceptor
 */
@Configuration
@EnableWebSecurity
public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {

        @Value(&quot;${security.oauth2.resource.introspection-uri}&quot;)
        String introspectionUri;

        @Value(&quot;${security.oauth2.client.client-id}&quot;)
        String clientId;

        @Value(&quot;${security.oauth2.client.client-secret}&quot;)
        String clientSecret;

        FixedAuthoritiesExtractor s;

        @Override
        protected void configure(HttpSecurity http) throws Exception {
                http
                        // Disabling CORS and CSRF makes POST on the graphql URL work properly. Double-check that before entering in production
                                .cors().and().csrf().disable()
                                .authorizeRequests(authz -&gt; authz
                                                .antMatchers(HttpMethod.GET, &quot;/graphql/subscription&quot;).authenticated()// .access(&quot;hasRole('ROLE_CLIENT')&quot;)
                                                .antMatchers(HttpMethod.POST, &quot;/graphql&quot;).authenticated()// .access(&quot;hasRole('ROLE_CLIENT')&quot;)
                                                .antMatchers(HttpMethod.GET, &quot;/graphiql&quot;).permitAll()
                                                // All other URL accesses are prohibited
                                                .anyRequest().denyAll())
                                .oauth2ResourceServer(oauth2 -&gt; oauth2.opaqueToken(
                                                // When all lines below are commented, then a custom OpaqueTokenIntrospector is used. See CustomAuthoritiesOpaqueTokenIntrospector
                                                token -&gt; token
                                                                .introspectionUri(this.introspectionUri)
                                                                .introspectionClientCredentials(this.clientId, this.clientSecret)
                                )
                        );
        }

        public String getIntrospectionUri() {
                return introspectionUri;
        }

        public void setIntrospectionUri(String introspectionUri) {
                this.introspectionUri = introspectionUri;
        }

        public String getClientId() {
                return clientId;
        }

        public void setClientId(String clientId) {
                this.clientId = clientId;
        }

        public String getClientSecret() {
                return clientSecret;
        }

        public void setClientSecret(String clientSecret) {
                this.clientSecret = clientSecret;
        }
}
</pre></div>
<p>For more information, don't hesitate to browse the web: there are tons of information on how to manage this, with Spring.</p>
<p>And the GraphQL server is just a standard Spring App!</p></section></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2021..      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
